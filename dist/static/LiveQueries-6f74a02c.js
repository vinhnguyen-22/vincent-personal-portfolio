import{r as u,bJ as K,M as V,cq as R,u as B,bU as N,ct as H,j as q,c as P}from"./sanity-05ba3066.js";import{c as J,a as X,g as Y,b as $}from"./PresentationToolGrantsCheck-4e4b18b1.js";import{b as z,u as G,a as W}from"./hooks-d811cc7e.js";import{i as x}from"./DisplayedDocumentBroadcaster-5ec2fcf3.js";function ae(S){const{liveDocument:e,controller:i,perspective:g,onLoadersConnection:r,onDocumentsOnPage:l}=S,[f,C]=u.useState(),[b,A]=u.useState({}),E=K(),T=V();u.useEffect(()=>{const s=setInterval(()=>A(t=>{if(Object.keys(t).length<1)return t;const y=Date.now();if(!Object.values(t).some(a=>a.heartbeat!==!1&&y>a.receivedAt+a.heartbeat))return t;const c={};for(const[a,m]of Object.entries(t))m.heartbeat!==!1&&y>m.receivedAt+m.heartbeat||(c[a]=m);return c}),R);return()=>clearInterval(s)},[]),u.useEffect(()=>{if(i){const s=i.createChannel({name:"presentation",connectTo:"loaders",heartbeat:!0},J().provide({actors:X()}));return C(s),s.onStatus(r),s.on("loader/documents",t=>{t.projectId===E&&t.dataset===T&&l("loaders",t.perspective,t.documents)}),s.on("loader/query-listen",t=>{if(t.projectId===E&&t.dataset===T){if(typeof t.heartbeat=="number"&&t.heartbeat<R)throw new Error(`Loader query listen heartbeat interval must be at least ${R}ms`);A(y=>({...y,[Y(t.query,t.params)]:{perspective:t.perspective,query:t.query,params:t.params,receivedAt:Date.now(),heartbeat:t.heartbeat??!1}}))}}),s.start()}},[i,T,l,r,E]);const[I]=u.useState(()=>new Set),[w,o]=u.useState(null),d=B({apiVersion:"2023-10-16"}),p=u.useMemo(()=>d.config(),[d]),h=u.useMemo(()=>d.withConfig({resultSourceMap:"withKeyArraySelector"}),[d]);u.useEffect(()=>{if(f){const{projectId:s,dataset:t}=p;f.post("loader/perspective",{projectId:s,dataset:t,perspective:g})}},[f,p,g]);const j=N(s=>{const t=Array.from(I).flat();s.tags.some(y=>t.includes(y))?o(s.id):console.log("No matching tags found",s.tags,{flattenedSyncTags:t})});u.useEffect(()=>{const s=H(h.config()).withConfig({apiVersion:"vX"}).live.events({includeDrafts:!0,tag:"presentation-loader"}).subscribe({next:t=>{t.type==="message"?j(t):t.type==="restart"?o(t.id):t.type==="reconnect"&&o(null)},error:t=>console.error("Error validating EventSource URL:",t)});return()=>s.unsubscribe()},[h,j]);const M=u.useDeferredValue(e);return q.jsx(q.Fragment,{children:Object.entries(b).map(([s,{query:t,params:y,perspective:c}])=>q.jsx(U,{projectId:p.projectId,dataset:p.dataset,perspective:c,query:t,params:y,comlink:f,client:h,liveDocument:M,lastLiveEventId:w,syncTagsInUse:I},`${s}${c}`))})}function Z(S){const e=P(14),{projectId:i,dataset:g,perspective:r,query:l,client:f,liveDocument:C,comlink:b,lastLiveEventId:A,syncTagsInUse:E}=S,T=G(S.params),{result:I,resultSourceMap:w,syncTags:o}=v({client:f,liveDocument:C,params:T,perspective:r,query:l,lastLiveEventId:A})||{};let d;e[0]!==g||e[1]!==i?(d=(M,s,t,y,c,a,m)=>{M==null||M.post("loader/query-change",{projectId:i,dataset:g,perspective:s,query:t,params:y,result:c,resultSourceMap:a,tags:m})},e[0]=g,e[1]=i,e[2]=d):d=e[2];const p=N(d);let h,j;return e[3]!==b||e[4]!==p||e[5]!==T||e[6]!==r||e[7]!==l||e[8]!==I||e[9]!==w||e[10]!==E||e[11]!==o?(h=()=>{if(w&&p(b,r,l,T,I,w,o),Array.isArray(o))return E.add(o),()=>{E.delete(o)}},j=[b,p,T,r,l,I,w,E,o],e[3]=b,e[4]=p,e[5]=T,e[6]=r,e[7]=l,e[8]=I,e[9]=w,e[10]=E,e[11]=o,e[12]=h,e[13]=j):(h=e[12],j=e[13]),u.useEffect(h,j),null}const U=u.memo(Z);U.displayName="Memo(QuerySubscription)";function v(S){const e=P(25),{liveDocument:i,client:g,query:r,params:l,perspective:f,lastLiveEventId:C}=S,[b,A]=u.useState(null),[E,T]=u.useState(null);if(E)throw E;let I;e[0]===Symbol.for("react.memo_cache_sentinel")?(I={refreshInterval:0},e[0]=I):I=e[0];const[w,o]=W(I),d=w==="refresh"||w==="inflight"||C!==(b==null?void 0:b.lastLiveEventId);let p,h;e[1]!==g||e[2]!==C||e[3]!==l||e[4]!==f||e[5]!==r||e[6]!==d||e[7]!==o?(p=()=>{if(!d)return;let c;c=!1;let a;a=!1;const m=new AbortController,k=async function(){const{signal:L}=m;a=!0;const{result:D,resultSourceMap:O,syncTags:Q}=await g.fetch(r,l,{lastLiveEventId:C,tag:"presentation-loader",signal:L,perspective:f,filterResponse:!1,returnQuery:!1});a=!1,L.aborted||(A(n=>({result:x(n==null?void 0:n.result,D)?n==null?void 0:n.result:D,resultSourceMap:x(n==null?void 0:n.resultSourceMap,O)?n==null?void 0:n.resultSourceMap:O,syncTags:x(n==null?void 0:n.syncTags,Q)?n==null?void 0:n.syncTags:Q,lastLiveEventId:C})),c=!0)},F=o();return k().catch(L=>{a=!1,L.name!=="AbortError"&&T(L)}).finally(F),()=>{!c&&!a&&m.abort()}},h=[g,C,l,f,r,d,o],e[1]=g,e[2]=C,e[3]=l,e[4]=f,e[5]=r,e[6]=d,e[7]=o,e[8]=p,e[9]=h):(p=e[8],h=e[9]),u.useEffect(p,h);let j;e[10]!==b?(j=b??{},e[10]=b,e[11]=j):j=e[11];const{result:M,resultSourceMap:s,syncTags:t}=j;let y;e:{if(i&&s){let a;e[12]!==i||e[13]!==f||e[14]!==s||e[15]!==M?(a=_(i,M,f,s),e[12]=i,e[13]=f,e[14]=s,e[15]=M,e[16]=a):a=e[16];let m;e[17]!==s||e[18]!==t||e[19]!==a?(m={result:a,resultSourceMap:s,syncTags:t},e[17]=s,e[18]=t,e[19]=a,e[20]=m):m=e[20],y=m;break e}let c;e[21]!==s||e[22]!==M||e[23]!==t?(c={result:M,resultSourceMap:s,syncTags:t},e[21]=s,e[22]=M,e[23]=t,e[24]=c):c=e[24],y=c}return y}function _(S,e,i,g){if(i==="raw")throw new Error("turboChargeResultIfSourceMap does not support raw perspective");return z(e,g,r=>{if(!r._projectId&&(S!=null&&S._id)&&$(S._id)===$(r._id))return S},(r,{previousValue:l})=>typeof r=="number"&&typeof l=="string"?`${r}`:r,i)}export{ae as default,_ as turboChargeResultIfSourceMap};
